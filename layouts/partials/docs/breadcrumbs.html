{{ $bookSection := default "/docs" .Site.Params.BookSection }}
{{ if eq $bookSection "*" }}
  {{ $bookSection = "/" }}
{{ end }}

{{ $bookRoot := .Site.GetPage $bookSection }}

{{ $siteEnabled := true }}
{{ if isset .Site.Params "bookbreadcrumbs" }}
  {{ $siteEnabled = .Site.Params.bookbreadcrumbs }}
{{ else if isset .Site.Params "BookBreadcrumbs" }}
  {{ $siteEnabled = index .Site.Params "BookBreadcrumbs" }}
{{ end }}

{{ $enabled := $siteEnabled }}
{{ if isset .Params "bookbreadcrumbs" }}
  {{ $enabled = .Params.bookbreadcrumbs }}
{{ else if isset .Params "BookBreadcrumbs" }}
  {{ $enabled = index .Params "BookBreadcrumbs" }}
{{ end }}

{{ $inBookScope := and $bookRoot (or (eq . $bookRoot) ($bookRoot.IsAncestor .)) }}

{{ if and $enabled (not .IsHome) $inBookScope }}
  {{ $start := . }}
  {{ $hasStart := false }}
  {{ range .Ancestors.Reverse }}
    {{ if and .IsSection .Params.bookBreadcrumbStart }}
      {{ $start = . }}
      {{ $hasStart = true }}
    {{ end }}
  {{ end }}
  {{ if and .IsSection .Params.bookBreadcrumbStart }}
    {{ $start = . }}
    {{ $hasStart = true }}
  {{ end }}

  {{ $shouldRender := and $hasStart (ne . $start) ($start.IsAncestor .) }}

  {{ if $shouldRender }}
    {{ $crumbs := slice }}
    {{ $include := false }}
    {{ range .Ancestors.Reverse }}
      {{ if eq . $start }}
        {{ $include = true }}
      {{ end }}
      {{ if and $include (not .IsHome) (ne . $bookRoot) }}
        {{ $crumbs = $crumbs | append . }}
      {{ end }}
    {{ end }}
    {{ if and (ne . $bookRoot) (or (eq . $start) ($start.IsAncestor .)) }}
      {{ $crumbs = $crumbs | append . }}
    {{ end }}

    {{ if gt (len $crumbs) 0 }}
      <nav class="book-breadcrumbs" aria-label="Breadcrumb">
        <ol>
          {{ $last := sub (len $crumbs) 1 }}
          {{ range $i, $p := $crumbs }}
            {{ $parent := $p.Parent }}
            {{ if not $parent }}
              {{ $parent = $bookRoot }}
            {{ end }}
            {{ $siblings := slice }}
            {{ range (where $parent.Pages "Params.bookhidden" "ne" true) }}
              {{ if .IsSection }}
                {{ $siblings = $siblings | append . }}
              {{ else if and .IsPage .Content }}
                {{ $siblings = $siblings | append . }}
              {{ end }}
            {{ end }}
            <li class="breadcrumb-item">
              {{/* Wrap label + chevron so the dropdown aligns to the text start. */}}
              <span class="breadcrumb-label">
                {{ if eq $i $last }}
                  <span aria-current="page">{{ partial "docs/title" $p }}</span>
                {{ else }}
                  <a href="{{ $p.RelPermalink }}">{{ partial "docs/title" $p }}</a>
                {{ end }}
                {{ if gt (len $siblings) 1 }}
                  {{/* VS Code-like dropdown for sibling items. */}}
                  <details class="breadcrumb-menu">
                    <summary aria-label="Show items in this folder" title="Show items in this folder"></summary>
                    <ul>
                      {{ range $s := $siblings }}
                        <li>
                          <a href="{{ $s.RelPermalink }}" class="{{ if eq $s $p }}active{{ end }}">
                            {{ partial "docs/title" $s }}
                          </a>
                        </li>
                      {{ end }}
                    </ul>
                  </details>
                {{ end }}
              </span>
            </li>
          {{ end }}
        </ol>
      </nav>
    {{ end }}
  {{ end }}
{{ end }}
