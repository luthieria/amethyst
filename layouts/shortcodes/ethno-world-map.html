{{- $entries := slice -}}
{{- $mapData := index site.Data "ethno-world-map" -}}
{{- $rawEntries := index $mapData "entries" | default (slice) -}}
{{- $scratch := newScratch -}}
{{- $scratch.Set "ethnoFlatEntries" (slice) -}}
{{- range $rawEntries -}}
  {{- partial "ethno/flatten-entry.html" (dict "entry" . "scratch" $scratch) -}}
{{- end -}}
{{- $flatEntries := $scratch.Get "ethnoFlatEntries" | default (slice) -}}
{{- range $flatEntries -}}
  {{- $entryPath := trim (default "" .path) " " -}}
  {{- $target := $.Page.GetPage $entryPath -}}
  {{- /* Fallback 1: resolve as page-relative path. */ -}}
  {{- if and (not $target) $entryPath -}}
    {{- $target = $.Page.GetPage (printf "./%s" $entryPath) -}}
  {{- end -}}
  {{- /* Fallback 2: resolve as absolute section path from current dir. */ -}}
  {{- if and (not $target) $entryPath $.Page.File -}}
    {{- $baseDir := strings.TrimSuffix "/" $.Page.File.Dir -}}
    {{- $absRef := printf "/%s" (path.Join $baseDir $entryPath) -}}
    {{- $target = site.GetPage $absRef -}}
  {{- end -}}
  {{- /* Fallback 3: resolve by explicit _index.md file path. */ -}}
  {{- if and (not $target) $entryPath $.Page.File -}}
    {{- $baseDir := strings.TrimSuffix "/" $.Page.File.Dir -}}
    {{- $fileRef := path.Join $baseDir $entryPath "_index.md" -}}
    {{- $target = site.GetPage $fileRef -}}
  {{- end -}}
  {{- if $target -}}
    {{- $entries = $entries | append (dict
      "id" .id
      "title" .title
      "path" $entryPath
      "url" $target.RelPermalink
      "depth" (.depth | default 1)
      "kind" (.kind | default "region")
      "lat" (.lat | default 0)
      "lon" (.lon | default 0)
      "dx" (.dx | default 0)
      "dy" (.dy | default 0)
      "halo_rx" (.halo_rx | default 0)
      "halo_ry" (.halo_ry | default 0)
      "halo_countries" (.halo_countries | default (slice))
    ) -}}
  {{- end -}}
{{- end -}}
{{- if gt (len $entries) 0 -}}
<div class="ethno-globe-layout" data-ethno-globe>
  <div class="ethno-globe-stage" role="region" aria-label="Interactive ethnomusicology globe">
    <div class="ethno-globe-loading">Loading globe...</div>
  </div>
  <script class="ethno-globe-data" type="application/json">{{ $entries | jsonify }}</script>
</div>
{{- else -}}
<p class="ethno-map-empty">No map entries resolve on this page.</p>
{{- end -}}
