{{- $data := index site.Data "ethno-world-map" -}}
{{- $entries := slice -}}
{{- $mapID := printf "ethno-world-map-%d" .Ordinal -}}
{{- with $data -}}
  {{- with .entries -}}
    {{- $entries = . -}}
  {{- end -}}
{{- end -}}

{{- $items := slice -}}
{{- range $index, $entry := $entries -}}
  {{- $path := default "" $entry.path -}}
  {{- $target := $.Page.GetPage $path -}}
  {{- if $target -}}
    {{- $depth := int (default 1 $entry.depth) -}}
    {{- $lat := default 0.0 $entry.lat -}}
    {{- $lon := default 0.0 $entry.lon -}}
    {{- $dx := default 16.0 $entry.dx -}}
    {{- $dy := default -12.0 $entry.dy -}}
    {{- $kind := lower (default "region" $entry.kind) -}}
    {{- $iso2 := upper (default "" $entry.iso2) -}}
    {{- $x := mul (div (add $lon 180.0) 360.0) 2000.0 -}}
    {{- $y := mul (div (sub 90.0 $lat) 180.0) 1001.0 -}}
    {{- $labelX := add $x $dx -}}
    {{- $labelY := add $y $dy -}}
    {{- $radius := cond (eq $depth 1) 9.0 (cond (eq $depth 2) 8.0 (cond (eq $depth 3) 7.0 6.0)) -}}
    {{- $haloRx := default 220.0 $entry.halo_rx -}}
    {{- $haloRy := default 140.0 $entry.halo_ry -}}
    {{- $haloRotate := default 0.0 $entry.halo_rotate -}}
    {{- $title := default $target.Title $entry.title -}}
    {{- $items = $items | append (dict
      "id" (default (printf "entry-%d" $index) $entry.id)
      "depth" $depth
      "kind" $kind
      "iso2" $iso2
      "title" $title
      "target" $target
      "x" $x
      "y" $y
      "labelX" $labelX
      "labelY" $labelY
      "radius" $radius
      "haloRx" $haloRx
      "haloRy" $haloRy
      "haloRotate" $haloRotate
    ) -}}
  {{- end -}}
{{- end -}}

{{- if gt (len $items) 0 -}}
{{- $baseMap := readFile "static/svg/world-countries-iso.svg" -}}
{{- $baseMap = replaceRE `(?s)^\s*<\?xml[^>]*>\s*` "" $baseMap -}}
<div class="ethno-map-layout">
  <div class="ethno-map-stage" role="img" aria-labelledby="{{ $mapID }}-title {{ $mapID }}-desc">
    <div class="ethno-map-base" aria-hidden="true">
      {{- $baseMap | safeHTML -}}
    </div>
    <svg class="ethno-map-overlay" viewBox="0 0 2000 1001" aria-labelledby="{{ $mapID }}-title {{ $mapID }}-desc">
      <title id="{{ $mapID }}-title">Mapa interactivo de etnomusicología</title>
      <desc id="{{ $mapID }}-desc">Mapa mundial con fronteras nacionales y regiones clicables para navegar notas de etnomusicología.</desc>
      <g class="ethno-map-hits">
        {{- range $items -}}
        {{- if and (eq .kind "country") (ne .iso2 "") -}}
        <a class="ethno-map-hit country depth-{{ .depth }}" href="{{ .target.RelPermalink }}" aria-label="{{ printf "Abrir %s" .title }}" tabindex="0">
          <title>{{ .title }}</title>
          <use href="#{{ .iso2 }}"></use>
          <use href="#{{ lower .iso2 }}"></use>
        </a>
        {{- else -}}
        <a class="ethno-map-hit region depth-{{ .depth }}" href="{{ .target.RelPermalink }}" aria-label="{{ printf "Abrir %s" .title }}" tabindex="0">
          <title>{{ .title }}</title>
          <ellipse
            cx="{{ printf "%.2f" .x }}"
            cy="{{ printf "%.2f" .y }}"
            rx="{{ printf "%.2f" .haloRx }}"
            ry="{{ printf "%.2f" .haloRy }}"
            transform="rotate({{ printf "%.2f" .haloRotate }} {{ printf "%.2f" .x }} {{ printf "%.2f" .y }})"></ellipse>
        </a>
        {{- end -}}
        {{- end -}}
      </g>
      <g class="ethno-map-labels">
        {{- range $items -}}
        <text class="ethno-map-label depth-{{ .depth }}" x="{{ printf "%.2f" .labelX }}" y="{{ printf "%.2f" .labelY }}">{{ .title }}</text>
        {{- end -}}
      </g>
    </svg>
  </div>

  {{/*
  <aside class="ethno-map-panel" aria-label="Navegación geográfica">
    <div class="ethno-map-panel-title">Índice geográfico</div>
    <nav aria-label="Índice geográfico de etnomusicología">
      <ol class="ethno-map-list">
        {{- range $items -}}
        <li class="depth-{{ .depth }}">
          <a href="{{ .target.RelPermalink }}">{{ .title }}</a>
        </li>
        {{- end -}}
      </ol>
    </nav>
  </aside>
  */}}
</div>
{{- else -}}
<p class="ethno-map-empty">No hay secciones geográficas configuradas para este mapa.</p>
{{- end -}}
