$ethno-page-scope: "body:is(.page-ethno-map-full, .page-ethno-map-full-active)";

#{$ethno-page-scope} {
  /* 1) Overlay activation + host layout overrides. */
  overflow: hidden !important;
  /* Lock page scrolling while the full-screen globe is active. */

  .singlePage {
    padding: 0 !important;
    margin: 0 !important;
    width: 100% !important;
    height: 100dvh !important;
    min-height: 100dvh !important;
  }

  main.flex {
    position: relative;
    height: 100dvh !important;
    min-height: 100dvh !important;
    overflow: hidden !important;
  }

  .book-toc {
    display: none !important;
  }

  .book-page.container {
    position: fixed !important;
    inset: 0 !important;
    width: 100vw !important;
    height: 100dvh !important;
    max-width: none !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
    z-index: 20 !important;
  }

  .book-page.container .markdown {
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
    height: 100% !important;
    overflow: hidden !important;
  }

  .book-page.container .markdown>* {
    margin-top: 0;
    margin-bottom: 0;
  }

  /* 2) Globe container and stage baseline. */
  .ethno-globe-layout,
  .ethno-globe-stage,
  .ethno-globe-svg {
    width: 100% !important;
    height: 100% !important;
  }

  .ethno-globe-layout {
    margin: 0;
    position: relative;
  }

  .ethno-globe-stage {
    position: relative;
    border: 0;
    border-radius: 0;
    overflow: hidden;
    background: transparent;
    box-shadow: none;
    isolation: isolate;
  }

  .ethno-globe-loading,
  .ethno-globe-error {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 1rem;
    color: rgba(236, 242, 252, 0.74);
    font-size: 0.72em;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    z-index: 1;
    pointer-events: none;
    text-align: center;
  }

  .ethno-globe-error {
    color: rgba(226, 148, 148, 0.95);
    text-transform: none;
    letter-spacing: normal;
  }

  .ethno-globe-svg {
    display: block;
    cursor: grab;
    touch-action: none;
  }

  /* 3) Drag-state interaction/performance overrides. */
  .ethno-globe-stage.is-dragging .ethno-globe-svg {
    cursor: grabbing;
  }

  .ethno-globe-stage.is-dragging .ethno-globe-country,
  .ethno-globe-stage.is-dragging .ethno-globe-borders,
  .ethno-globe-stage.is-dragging .ethno-globe-territory-island,
  .ethno-globe-stage.is-dragging .ethno-globe-link path,
  .ethno-globe-stage.is-dragging .ethno-globe-microstate {
    transition: none !important;
    /* Remove visual lag while rotating/dragging the globe. */
  }

  .ethno-globe-stage.is-dragging .ethno-globe-link.region .ethno-globe-region-halo,
  .ethno-globe-stage.is-dragging .ethno-globe-link.region:hover .ethno-globe-region-halo,
  .ethno-globe-stage.is-dragging .ethno-globe-link.region:focus .ethno-globe-region-halo,
  .ethno-globe-stage.is-dragging .ethno-globe-link.region:focus-visible .ethno-globe-region-halo {
    opacity: 0.88;
    filter: blur(4px) drop-shadow(0 0 6px var(--ethno-region-glow, rgba(248, 252, 255, 0.15))) !important;
  }

  .ethno-globe-stage.is-dragging .ethno-globe-microstate {
    filter: none !important;
    opacity: 0.78;
  }

  .ethno-globe-stage.is-dragging .ethno-globe-label-link {
    pointer-events: none;
  }

  /* 4) Base globe geometry layers. */
  .ethno-globe-backdrop {
    fill: #090e14;
  }

  .ethno-globe-sphere {
    fill: #0b1118;
    filter: drop-shadow(0 0 1rem rgba(198, 218, 255, 0.12));
  }

  .ethno-globe-country {
    fill: rgba(14, 21, 32, 0.8);
    stroke: rgba(246, 250, 255, 0.11);
    stroke-width: 0.38;
    vector-effect: non-scaling-stroke;
  }

  .ethno-globe-borders {
    fill: none;
    stroke: rgba(255, 255, 255, 0.14);
    stroke-width: 0.36;
    vector-effect: non-scaling-stroke;
    pointer-events: none;
  }

  .ethno-globe-coastline {
    fill: none;
    stroke: rgba(236, 244, 255, 0.8);
    stroke-width: 0.5;
    vector-effect: non-scaling-stroke;
    pointer-events: none;
    filter: drop-shadow(0 0 2px rgba(198, 218, 255, 0.14));
  }

  .ethno-globe-territory-islands,
  .ethno-globe-microstates {
    pointer-events: none;
  }

  .ethno-globe-territory-island {
    fill: rgba(17, 25, 37, 0.72);
    stroke: rgba(240, 248, 255, 0.22);
    stroke-width: 0.44;
    vector-effect: non-scaling-stroke;
    pointer-events: none;
  }

  .ethno-globe-microstate {
    fill: var(--ethno-micro-fill, rgba(246, 250, 255, 0.32));
    stroke: var(--ethno-micro-stroke, rgba(246, 250, 255, 0.44));
    stroke-width: 0.35;
    vector-effect: non-scaling-stroke;
    filter: none;
    opacity: 0.72;
  }

  /* 5) Sidebar overlay layer. */
  .book-menu {
    position: fixed !important;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 120 !important;
  }

  .book-menu .book-menu-content {
    margin-top: 0 !important;
    height: 100dvh !important;
    background: rgba(30, 30, 30, 0.3) !important;
    backdrop-filter: blur(16px) !important;
    -webkit-backdrop-filter: blur(16px) !important;
  }

  /* 6) Label typography. */
  .ethno-globe-labels text {
    fill: rgba(248, 252, 255, 0.98);
    font-family: var(--font-sans) !important;
    font-size: 0.8em !important;
    font-weight: 650;
    stroke: none !important;
    stroke-width: 0 !important;
    paint-order: normal !important;
    pointer-events: none;
    user-select: none;
    letter-spacing: 0.016em;
    line-height: 1.1;
    text-rendering: geometricPrecision;
    -webkit-font-smoothing: antialiased;
    transition: fill 0.16s ease, opacity 0.16s ease;
  }

  .ethno-globe-labels .depth-2 {
    font-size: 0.7em !important;
  }

  .ethno-globe-labels .depth-3 {
    font-size: 0.65em !important;
  }

  .ethno-globe-labels .depth-4 {
    font-size: 0.6em !important;
  }

  .ethno-globe-label-link {
    cursor: pointer;
    outline: none;
    text-decoration: none;
  }

  .ethno-globe-label-link .ethno-globe-label-chip {
    fill: rgba(8, 13, 22, 0.64);
    stroke: rgba(250, 252, 255, 0.3);
    stroke-width: 1.02;
    filter: drop-shadow(0 0.28rem 0.92rem rgba(0, 0, 0, 0.29));
    backdrop-filter: blur(7px);
    -webkit-backdrop-filter: blur(7px);
    transition: fill 0.16s ease, stroke 0.16s ease, filter 0.16s ease, transform 0.16s ease;
  }

  .ethno-globe-label-link[data-entry-kind="region"] .ethno-globe-label-chip {
    stroke-dasharray: 2.4 2.8;
    stroke-linecap: round;
  }

  .ethno-globe-label-link:hover .ethno-globe-label-chip,
  .ethno-globe-label-link:focus .ethno-globe-label-chip,
  .ethno-globe-label-link:focus-visible .ethno-globe-label-chip,
  .ethno-globe-label-link.is-linked-hover .ethno-globe-label-chip {
    fill: rgba(10, 18, 30, 0.8);
    stroke: var(--ethno-label-accent, rgba(248, 252, 255, 0.54));
    filter: drop-shadow(0 0.35rem 1.12rem rgba(0, 0, 0, 0.35)) drop-shadow(0 0 0.45rem var(--ethno-label-chip-glow, rgba(248, 252, 255, 0.24)));
    transform: translateY(-0.24px);
  }

  .ethno-globe-label-link:hover text,
  .ethno-globe-label-link:focus text,
  .ethno-globe-label-link:focus-visible text,
  .ethno-globe-label-link.is-linked-hover text {
    fill: rgba(254, 255, 255, 1);
  }

  .ethno-globe-label-link:focus-visible .ethno-globe-label-chip {
    filter: drop-shadow(0 0 0.42rem rgba(246, 251, 255, 0.72));
  }

  /* 7) Country/region interaction visuals. */
  .ethno-globe-link {
    cursor: pointer;
    outline: none;
  }

  .ethno-globe-link path {
    vector-effect: non-scaling-stroke;
    transition: fill 0.16s ease, stroke 0.16s ease, opacity 0.16s ease, filter 0.16s ease, transform 0.16s ease;
  }

  .ethno-globe-link.country path {
    fill: var(--ethno-country-fill, rgba(255, 255, 255, 0.02));
    stroke: var(--ethno-country-stroke, rgba(255, 255, 255, 0.45));
    stroke-width: 1.16;
  }

  .ethno-globe-link.country:hover path,
  .ethno-globe-link.country:focus path,
  .ethno-globe-link.country.is-linked-hover path {
    fill: var(--ethno-country-fill-hover, rgba(191, 97, 106, 0.34));
    stroke: var(--ethno-country-stroke-hover, rgba(248, 252, 255, 0.87));
  }

  .ethno-globe-link.region .ethno-globe-region-halo {
    fill: var(--ethno-region-fill, rgba(255, 255, 255, 0.03));
    stroke: var(--ethno-region-stroke, rgba(255, 255, 255, 0.12));
    stroke-width: 3.4;
    stroke-linejoin: round;
    stroke-linecap: round;
    opacity: 0.92;
    pointer-events: none;
    transform-box: fill-box;
    transform-origin: center;
    filter: blur(7px) drop-shadow(0 0 8px var(--ethno-region-glow, rgba(248, 252, 255, 0.18)));
  }

  .ethno-globe-link.region .ethno-globe-region-hit {
    fill: var(--ethno-region-hit-fill, rgba(255, 255, 255, 0.01));
    stroke: transparent;
    stroke-width: 0.6;
  }

  .ethno-globe-link.region:hover .ethno-globe-region-halo,
  .ethno-globe-link.region:focus .ethno-globe-region-halo,
  .ethno-globe-link.region:focus-visible .ethno-globe-region-halo,
  .ethno-globe-link.region.is-linked-hover .ethno-globe-region-halo {
    fill: var(--ethno-region-fill-hover, rgba(248, 252, 255, 0.08));
    stroke: var(--ethno-region-stroke-hover, rgba(248, 252, 255, 0.32));
    filter: blur(9px) drop-shadow(0 0 13px var(--ethno-region-glow, rgba(248, 252, 255, 0.2)));
  }

  .ethno-globe-link.region:hover .ethno-globe-region-hit,
  .ethno-globe-link.region:focus .ethno-globe-region-hit,
  .ethno-globe-link.region:focus-visible .ethno-globe-region-hit,
  .ethno-globe-link.region.is-linked-hover .ethno-globe-region-hit {
    fill: var(--ethno-region-hit-fill-hover, rgba(255, 255, 255, 0.03));
  }

  .ethno-globe-link.country:focus-visible path,
  .ethno-globe-link.region:focus-visible .ethno-globe-region-hit {
    filter: drop-shadow(0 0 0.28rem rgba(246, 251, 255, 0.82));
  }

  /* 8) Mobile-only typography/tooltip adjustments. */
  @media screen and (max-width: 56rem) {
    .ethno-globe-hint {
      top: 0.08rem !important;
      font-size: 0.56em !important;
      max-width: calc(100% - 1.5rem);
      text-align: center;
      white-space: normal;
    }

    .ethno-globe-labels text {
      font-size: 0.56em !important;
    }
  }
}

/* 9) Global non-ethno overrides. */
.ethno-map-empty {
  margin: 1rem 0;
  color: var(--gray);
}

/* Match Markdown Preview Enhanced footnote back-arrow appearance. */
.markdown .footnotes .footnote-backref,
.markdown .footnotes a[href^="#fnref"] {
  font-size: 0.7em;
  font-weight: normal;
  text-decoration: none;
  opacity: 0.3;
}

/* Keep Markdown images centered in rendered note content. */
.markdown img {
  display: block;
  margin-left: auto;
  margin-right: auto;
}